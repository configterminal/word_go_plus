# 数据库表结构设计

## 1. 数据库概述

本项目采用SQLite数据库，主要存储用户信息和AI3D模型相关数据。数据库设计遵循第三范式，确保数据的一致性、完整性和可维护性。

## 2. 表结构设计

### 2.1 用户模块

#### 用户表（users）

| 字段名               | 类型         | 描述                              | 约束                    |
|----------------------|--------------|-----------------------------------|-------------------------|
| id                   | INTEGER      | 主键，自增                        | PRIMARY KEY, AUTOINCREMENT |
| username             | VARCHAR(64)  | 用户名，唯一                      | UNIQUE, NOT NULL       |
| password             | VARCHAR(128) | 密码（加密存储）                  | NOT NULL               |
| email                | VARCHAR(128) | 邮箱                              | NOT NULL               |
| role                 | VARCHAR(32)  | 角色（user/admin/vip等）          | DEFAULT 'user'         |
| nickname             | VARCHAR(64)  | 昵称                              |                         |
| avatar               | VARCHAR(512) | 头像URL                           |                         |
| bio                  | VARCHAR(500) | 个人简介                          |                         |
| gender               | VARCHAR(16)  | 性别（male/female/other）         |                         |
| birthday             | TIMESTAMP    | 生日                              |                         |
| location             | VARCHAR(128) | 所在地                            |                         |
| website              | VARCHAR(256) | 个人网站                          |                         |
| works_count          | INTEGER      | 作品数量                          | DEFAULT 0              |
| followers_count      | INTEGER      | 粉丝数量                          | DEFAULT 0              |
| following_count      | INTEGER      | 关注数量                          | DEFAULT 0              |
| likes_count          | INTEGER      | 获赞数量                          | DEFAULT 0              |
| daily_generation_count| INTEGER     | 每日剩余生成次数                  | DEFAULT 20             |
| last_reset_date      | TIMESTAMP    | 上次重置日期                      |                         |
| status               | VARCHAR(16)  | 状态（active/inactive/banned）    | DEFAULT 'active'       |
| last_login_at        | TIMESTAMP    | 最后登录时间                      |                         |
| created_at           | TIMESTAMP    | 创建时间                          | NOT NULL               |
| updated_at           | TIMESTAMP    | 更新时间                          | NOT NULL               |

### 2.2 AI3D模型模块

#### AI3D模型表（ai3d_models）

| 字段名            | 类型         | 描述                          | 约束                    |
|-------------------|--------------|-------------------------------|-------------------------|
| id                | INTEGER      | 主键，自增                    | PRIMARY KEY, AUTOINCREMENT |
| user_id           | INTEGER      | 所属用户ID，关联users表       | NOT NULL               |
| title             | VARCHAR(256) | 模型标题                      | NOT NULL               |
| description       | TEXT         | 模型描述                      |                         |
| input_type        | VARCHAR(16)  | 输入类型（text/image）        |                         |
| input_content     | TEXT         | 输入内容                      |                         |
| model_version     | VARCHAR(16)  | 模型版本（v1.5/v2.0/v2.5）   |                         |
| polygon_count     | VARCHAR(16)  | 多边形数量（default/50k/150k/300k） |                 |
| generation_type   | VARCHAR(16)  | 生成类型（combined/separate） |                         |
| output_url        | VARCHAR(512) | 生成的3D模型URL               |                         |
| thumbnail_url     | VARCHAR(512) | 缩略图URL                     |                         |
| category          | VARCHAR(64)  | 分类                          |                         |
| status            | VARCHAR(16)  | 状态（processing/completed/failed） | DEFAULT 'processing' |
| generation_time   | INTEGER      | 生成耗时（秒）                |                         |
| view_count        | INTEGER      | 查看次数                      | DEFAULT 0              |
| download_count    | INTEGER      | 下载次数                      | DEFAULT 0              |
| like_count        | INTEGER      | 点赞次数                      | DEFAULT 0              |
| collect_count     | INTEGER      | 收藏次数                      | DEFAULT 0              |
| tags              | VARCHAR(512) | 标签，逗号分隔                |                         |
| is_public         | BOOLEAN      | 是否公开                      | DEFAULT true           |
| created_at        | TIMESTAMP    | 创建时间                      | NOT NULL               |
| updated_at        | TIMESTAMP    | 更新时间                      | NOT NULL               |

#### AI3D生成日志表（ai3d_generation_logs）

| 字段名        | 类型         | 描述                          | 约束                    |
|---------------|--------------|-------------------------------|-------------------------|
| id            | INTEGER      | 主键，自增                    | PRIMARY KEY, AUTOINCREMENT |
| model_id      | INTEGER      | 关联ai3d_models表             | NOT NULL               |
| step          | VARCHAR(64)  | 生成步骤                      |                         |
| progress      | INTEGER      | 进度百分比                    |                         |
| message       | TEXT         | 步骤消息                      |                         |
| created_at    | TIMESTAMP    | 创建时间                      | NOT NULL               |

## 3. 表关系说明

### 3.1 主要关系

- **用户表（users）** 是核心表，AI3D模型表通过 `user_id` 关联
- **AI3D模型表（ai3d_models）** 通过 `user_id` 关联用户，一个用户可以有多个AI3D模型
- **AI3D生成日志表（ai3d_generation_logs）** 通过 `model_id` 关联AI3D模型

### 3.2 关系图

```
users (1) ←→ (N) ai3d_models
ai3d_models (1) ←→ (N) ai3d_generation_logs
```

## 4. 索引设计

为提高查询性能，建议在以下字段上创建索引：

```sql
-- 用户表索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_status ON users(status);

-- AI3D模型表索引
CREATE INDEX idx_ai3d_models_user_id ON ai3d_models(user_id);
CREATE INDEX idx_ai3d_models_status ON ai3d_models(status);
CREATE INDEX idx_ai3d_models_category ON ai3d_models(category);
CREATE INDEX idx_ai3d_models_is_public ON ai3d_models(is_public);

-- AI3D生成日志表索引
CREATE INDEX idx_ai3d_generation_logs_model_id ON ai3d_generation_logs(model_id);
```

## 5. 数据完整性和安全性策略

### 5.1 约束设计

1. **主键约束**：所有表的id字段为主键，确保记录唯一性
2. **外键约束**：建立适当的外键关系，确保数据一致性
3. **非空约束**：关键字段（如username、password、title、user_id等）设置为非空
4. **唯一约束**：对用户名、邮箱等字段设置唯一约束
5. **默认值**：为部分字段设置合理默认值（如role默认值为'user'）

### 5.2 数据安全

1. **数据加密**：敏感数据（如密码）采用加密存储
2. **访问控制**：通过数据库角色和权限控制，确保数据安全
3. **输入验证**：在应用层进行数据验证，防止SQL注入等攻击
4. **定期备份**：实施定期数据库备份策略

### 5.3 性能优化

1. **索引优化**：在常用查询字段上建立合适的索引
2. **查询优化**：避免N+1查询问题，使用适当的JOIN操作
3. **分页处理**：对大量数据的查询实现分页处理
4. **缓存策略**：对热点数据实施缓存策略

## 6. 数据库迁移策略

### 6.1 自动迁移

项目使用GORM的AutoMigrate功能，自动创建和更新表结构：

```go
err = DB.AutoMigrate(
    &models.User{},
    &models.AI3DModel{},
    &models.AI3DGenerationLog{},
)
```

### 6.2 版本管理

- 开发环境：使用 `InitDB()` 函数
- 生产环境：使用 `InitDBProduction()` 函数
- 支持手动数据库检查和清理命令

## 7. 扩展性考虑

### 7.1 水平扩展

- 支持读写分离
- 支持分库分表
- 支持缓存层（Redis）

### 7.2 功能扩展

- 支持更多媒体类型
- 支持更复杂的权限系统
- 支持国际化
- 支持插件系统